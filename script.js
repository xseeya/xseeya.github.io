import * as musicMetadata from 'https://cdn.jsdelivr.net/npm/music-metadata-browser/+esm';

const themeSwitcher = document.querySelector('.theme-switcher');
const darkModeClass = 'dark';
const sunIcon = 'üåû';
const moonIcon = 'üåì';
const themeKey = 'theme';

function toggleTheme() {
    const isDark = document.body.classList.toggle(darkModeClass);
    themeSwitcher.textContent = isDark ? moonIcon : sunIcon;
    localStorage.setItem(themeKey, isDark ? 'dark' : 'light');
}
window.toggleTheme = toggleTheme;

document.addEventListener('DOMContentLoaded', async () => {
    // –ò–∑–Ω–∞—á–∞–ª—å–Ω–æ —Å–∫—Ä—ã–≤–∞–µ–º —Ç–µ–∫—Å—Ç –ø–µ—Å–Ω–∏
    document.querySelector('.lyrics-container').classList.remove('visible');
    
    const savedTheme = localStorage.getItem(themeKey);
    if (savedTheme === 'dark') {
        document.body.classList.add(darkModeClass);
        themeSwitcher.textContent = moonIcon;
    } else {
        themeSwitcher.textContent = sunIcon;
    }

    try {
        const response = await fetch('music.mp3');
        if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
        const blob = await response.blob();
        const metadata = await musicMetadata.parseBlob(blob);

        document.getElementById('song-title').textContent = metadata.common.title || "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π —Ç—Ä–µ–∫";
        document.getElementById('song-artist').textContent = metadata.common.artist || "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—å";

        if (metadata.common.picture?.length) {
            const picture = metadata.common.picture[0];
            const base64String = arrayBufferToBase64(picture.data);
            document.getElementById('album-art').src = `data:${picture.format};base64,${base64String}`;
        }

        if (metadata.format.duration) {
            document.getElementById('duration').textContent = formatTime(metadata.format.duration);
        }

        // –°–±—Ä–æ—Å –ø—Ä–æ–≥—Ä–µ—Å—Å –±–∞—Ä–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
        progressBar.style.width = '0%';
        currentTimeEl.textContent = '0:00';
    } catch (err) {
        console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ —á—Ç–µ–Ω–∏–∏ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã—Ö:", err);
        document.getElementById('song-title').textContent = "–û—à–∏–±–∫–∞ —á—Ç–µ–Ω–∏—è —Ç–µ–≥–æ–≤";
        document.getElementById('song-artist').textContent = "";
    }
});

function arrayBufferToBase64(buffer) {
    let binary = '';
    const bytes = new Uint8Array(buffer);
    for (let i = 0; i < bytes.length; i++) {
        binary += String.fromCharCode(bytes[i]);
    }
    return window.btoa(binary);
}

const audioPlayer = document.getElementById('audio-player');
const playPauseBtn = document.getElementById('play-pause-btn');
const progressBar = document.getElementById('progress');
const progressContainer = document.querySelector('.progress-bar');
const currentTimeEl = document.getElementById('current-time');
const durationEl = document.getElementById('duration');
const albumCover = document.querySelector('.album-cover');
const lyricsLine = document.getElementById('lyrics-line');
const loadingAnimation = document.querySelector('.loading-animation');
if (loadingAnimation) {
    loadingAnimation.style.animation = 'noteToLyrics 1s ease-in-out forwards';
}

// —Ç—É–ª—Ç–∏–ø –≤—Ä–µ–º–µ–Ω–∏
const timeTooltip = document.createElement('div');
timeTooltip.classList.add('time-tooltip');
progressContainer.appendChild(timeTooltip);

let isPlaying = false;
let isDragging = false;
let isPlayingBeforeDrag = false;
let dragPercent = 0;

function playPause() {
    if (isPlaying) {
        audioPlayer.pause();
        playPauseBtn.innerHTML = '<i class="fas fa-play"></i>';
        albumCover.classList.remove('playing');
    } else {
        audioPlayer.play();
        playPauseBtn.innerHTML = '<i class="fas fa-pause"></i>';
        albumCover.classList.add('playing');
    }
    isPlaying = !isPlaying;
}

function updateProgress() {
    if (!isDragging) {
        const { duration, currentTime } = audioPlayer;
        if (!isNaN(duration)) {
            const progressPercent = (currentTime / duration) * 100;
            progressBar.style.width = `${progressPercent}%`;
            currentTimeEl.textContent = formatTime(currentTime);
            durationEl.textContent = formatTime(duration);
        }
    }
}

function formatTime(seconds) {
    if (!seconds || isNaN(seconds)) return "0:00";
    const mins = Math.floor(seconds / 60);
    const secs = Math.floor(seconds % 60).toString().padStart(2, '0');
    return `${mins}:${secs}`;
}

function updateDragPosition(e) {
    const rect = progressContainer.getBoundingClientRect();
    const offsetX = Math.min(Math.max(e.clientX - rect.left, 0), rect.width);
    dragPercent = offsetX / rect.width;
    progressBar.style.width = `${dragPercent * 100}%`;
    const previewTime = dragPercent * audioPlayer.duration;
    currentTimeEl.textContent = formatTime(previewTime);
    updateTooltip(offsetX, previewTime);
}

function updateTooltip(offsetX, time) {
    timeTooltip.textContent = formatTime(time);
    timeTooltip.style.left = `${offsetX}px`;
}

progressContainer.addEventListener('mousedown', (e) => {
    isDragging = true;
    isPlayingBeforeDrag = !audioPlayer.paused;
    updateDragPosition(e);
});
document.addEventListener('mousemove', (e) => {
    if (isDragging) updateDragPosition(e);
});
document.addEventListener('mouseup', () => {
    if (isDragging) {
        isDragging = false;
        audioPlayer.currentTime = dragPercent * audioPlayer.duration;
        updateProgress();
        if (isPlayingBeforeDrag) audioPlayer.play();
        isPlayingBeforeDrag = false;
    }
});

progressContainer.addEventListener('mousemove', (e) => {
    const rect = progressContainer.getBoundingClientRect();
    const offsetX = Math.min(Math.max(e.clientX - rect.left, 0), rect.width);
    const percent = offsetX / rect.width;
    const previewTime = percent * audioPlayer.duration;
    updateTooltip(offsetX, previewTime);
    timeTooltip.style.opacity = 1;
});
progressContainer.addEventListener('mouseleave', () => {
    timeTooltip.style.opacity = 0;
});

playPauseBtn.addEventListener('click', playPause);
audioPlayer.addEventListener('timeupdate', () => {
    updateProgress();
    const currentTime = audioPlayer.currentTime;
    if (currentTime >= 10 && currentTime <= 15) { // –ü—Ä–∏–º–µ—Ä —Ç–∞–π–º–∏–Ω–≥–∞
        // –°–∫—Ä—ã—Ç—å –∑–Ω–∞–∫
        const someSign = document.querySelector('.some-sign');
        if (someSign) {
            someSign.style.display = 'none';
        }
    } else {
        // –ü–æ–∫–∞–∑–∞—Ç—å –∑–Ω–∞–∫
        const someSign = document.querySelector('.some-sign');
        if (someSign) {
            someSign.style.display = 'block';
        }
    }
});
audioPlayer.addEventListener('ended', () => {
    playPauseBtn.innerHTML = '<i class="fas fa-play"></i>';
    albumCover.classList.remove('playing');
    isPlaying = false;
    lyricsLine.classList.remove('fade-in');
    lyricsLine.classList.add('fade-out');
});

audioPlayer.addEventListener('play', () => {
    const container = document.querySelector('.lyrics-container');
    container.classList.add('visible');
    // Force reflow to trigger transition
    void container.offsetHeight;
    setTimeout(() => {
        lyricsLine.classList.remove('fade-out');
        lyricsLine.classList.add('fade-in');
    }, 100); // –ù–µ–±–æ–ª—å—à–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞ –¥–ª—è –ø–æ—è–≤–ª–µ–Ω–∏—è –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞

    // –ü–ª–∞–≤–Ω–æ —Å—ä–µ–∑–∂–∞–µ–º –±–ª–æ–∫ links –≤–Ω–∏–∑
    const linksBlock = document.querySelector('.links');
    linksBlock.style.marginTop = '15px';
});

audioPlayer.addEventListener('pause', () => {
    lyricsLine.classList.remove('fade-in');
    lyricsLine.classList.add('fade-out');
    setTimeout(() => {
        document.querySelector('.lyrics-container').classList.remove('visible');
        document.querySelector('.links').style.marginTop = '-85px'; // –í–æ–∑–≤—Ä–∞—â–∞–µ–º –±–ª–æ–∫ —Å —Å–æ—Ü. —Å–µ—Ç—è–º–∏ –Ω–∞ –º–µ—Å—Ç–æ
    }, 500); // –£–≤–µ–ª–∏—á–∏–ª–∏ –∑–∞–¥–µ—Ä–∂–∫—É –¥–ª—è –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –∞–Ω–∏–º–∞—Ü–∏–∏
});

audioPlayer.addEventListener('ended', () => {
    lyricsLine.classList.remove('fade-in');
    lyricsLine.classList.add('fade-out');
    setTimeout(() => {
        document.querySelector('.lyrics-container').classList.remove('visible');
    }, 500); // –£–≤–µ–ª–∏—á–∏–ª–∏ –∑–∞–¥–µ—Ä–∂–∫—É –¥–ª—è –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –∞–Ω–∏–º–∞—Ü–∏–∏
});

// –≥—Ä–æ–º–∫–æ—Å—Ç—å + mute
const volumeWrapper = document.querySelector('.volume-wrapper');
const volumeToggle = document.querySelector('.volume-toggle');
const volumeSlider = document.getElementById('volume-slider');
const volumeBar = document.querySelector('.volume-bar');
let isMuted = false;

volumeSlider.value = audioPlayer.volume;

function showVolumeBar() {
    volumeBar.classList.add('visible');
}

function hideVolumeBar() {
    volumeBar.classList.remove('visible');
}

volumeSlider.addEventListener('input', () => {
    audioPlayer.volume = volumeSlider.value;
    if (audioPlayer.volume > 0) {
        isMuted = false;
        audioPlayer.muted = false;
        volumeToggle.innerHTML = '<i class="fas fa-volume-up"></i>';
        volumeWrapper.classList.remove('active');
    } else {
        isMuted = true;
        audioPlayer.muted = true;
        volumeToggle.innerHTML = '<i class="fas fa-volume-mute"></i>';
        volumeWrapper.classList.add('active');
    }
});

volumeToggle.addEventListener('click', () => {
    volumeWrapper.classList.toggle('active');
    isMuted = !isMuted;
    audioPlayer.muted = isMuted;
    volumeToggle.innerHTML = isMuted
        ? '<i class="fas fa-volume-mute"></i>'
        : '<i class="fas fa-volume-up"></i>';
});

// –ü–æ–∫–∞–∑—ã–≤–∞—Ç—å –ø–æ–ª–∑—É–Ω–æ–∫ –ø—Ä–∏ –Ω–∞–≤–µ–¥–µ–Ω–∏–∏ –Ω–∞ –∏–∫–æ–Ω–∫—É
volumeToggle.addEventListener('mouseenter', showVolumeBar);
volumeBar.addEventListener('mouseenter', showVolumeBar);

// –°–∫—Ä—ã–≤–∞—Ç—å –ø–æ–ª–∑—É–Ω–æ–∫ –ø—Ä–∏ —É—Ö–æ–¥–µ –∫—É—Ä—Å–æ—Ä–∞ —Å –æ–±–µ–∏—Ö –æ–±–ª–∞—Å—Ç–µ–π
volumeWrapper.addEventListener('mouseleave', (e) => {
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –∫—É—Ä—Å–æ—Ä –Ω–µ –Ω–∞–¥ –ø–æ–ª–∑—É–Ω–∫–æ–º –∏ –Ω–µ –Ω–∞–¥ –∏–∫–æ–Ω–∫–æ–π
    if (!volumeBar.matches(':hover') && !volumeToggle.matches(':hover')) {
        hideVolumeBar();
    }
});
