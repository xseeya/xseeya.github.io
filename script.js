import * as musicMetadata from 'https://cdn.jsdelivr.net/npm/music-metadata-browser/+esm';

// –≠–ª–µ–º–µ–Ω—Ç—ã DOM
const themeSwitcher = document.querySelector('.theme-switcher');
const audioPlayer = document.getElementById('audio-player');
const playPauseBtn = document.getElementById('play-pause-btn');
const progressBar = document.getElementById('progress');
const progressContainer = document.querySelector('.progress-bar');
const currentTimeEl = document.getElementById('current-time');
const durationEl = document.getElementById('duration');
const albumCover = document.querySelector('.album-cover');
const lyricsLine = document.getElementById('lyrics-line');
const loadingAnimation = document.querySelector('.loading-animation');

// –ö–æ–Ω—Å—Ç–∞–Ω—Ç—ã
const darkModeClass = 'dark';
const sunIcon = 'üåû';
const moonIcon = 'üåì';
const themeKey = 'theme';

// –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è
let isPlaying = false;
let isDragging = false;
let isPlayingBeforeDrag = false;
let dragPercent = 0;

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Ç—É–ª—Ç–∏–ø–∞ –≤—Ä–µ–º–µ–Ω–∏
const timeTooltip = document.createElement('div');
timeTooltip.classList.add('time-tooltip');
progressContainer.appendChild(timeTooltip);

// –§—É–Ω–∫—Ü–∏–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Ç–µ–º–æ–π
function toggleTheme() {
    const isDark = document.body.classList.toggle(darkModeClass);
    themeSwitcher.textContent = isDark ? moonIcon : sunIcon;
    localStorage.setItem(themeKey, isDark ? 'dark' : 'light');
}

window.toggleTheme = toggleTheme;

// –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –∞—É–¥–∏–æ
function playPause() {
    if (isPlaying) {
        audioPlayer.pause();
        playPauseBtn.innerHTML = '<i class="fas fa-play"></i>';
        albumCover.classList.remove('playing');
    } else {
        audioPlayer.play();
        playPauseBtn.innerHTML = '<i class="fas fa-pause"></i>';
        albumCover.classList.add('playing');
    }
    isPlaying = !isPlaying;
}

function updateProgress() {
    if (!isDragging) {
        const { duration, currentTime } = audioPlayer;
        if (!isNaN(duration)) {
            const progressPercent = (currentTime / duration) * 100;
            progressBar.style.width = `${progressPercent}%`;
            currentTimeEl.textContent = formatTime(currentTime);
            durationEl.textContent = formatTime(duration);
        }
    }
}

function formatTime(seconds) {
    if (!seconds || isNaN(seconds)) return "0:00";
    const mins = Math.floor(seconds / 60);
    const secs = Math.floor(seconds % 60).toString().padStart(2, '0');
    return `${mins}:${secs}`;
}

// –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –ø—Ä–æ–≥—Ä–µ—Å—Å –±–∞—Ä–æ–º
function updateDragPosition(e) {
    const rect = progressContainer.getBoundingClientRect();
    const offsetX = Math.min(Math.max(e.clientX - rect.left, 0), rect.width);
    dragPercent = offsetX / rect.width;
    progressBar.style.width = `${dragPercent * 100}%`;
    const previewTime = dragPercent * audioPlayer.duration;
    currentTimeEl.textContent = formatTime(previewTime);
    updateTooltip(offsetX, previewTime);
}

function updateTooltip(offsetX, time) {
    timeTooltip.textContent = formatTime(time);
    timeTooltip.style.left = `${offsetX}px`;
}

// –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –≥—Ä–æ–º–∫–æ—Å—Ç—å—é
const volumeWrapper = document.querySelector('.volume-wrapper');
const volumeToggle = document.querySelector('.volume-toggle');
const volumeSlider = document.getElementById('volume-slider');
const volumeBar = document.querySelector('.volume-bar');
let isMuted = false;

function showVolumeBar() {
    volumeBar.classList.add('visible');
}

function hideVolumeBar() {
    volumeBar.classList.remove('visible');
}

// –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏
function arrayBufferToBase64(buffer) {
    let binary = '';
    const bytes = new Uint8Array(buffer);
    for (let i = 0; i < bytes.length; i++) {
        binary += String.fromCharCode(bytes[i]);
    }
    return window.btoa(binary);
}

// –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π –¥–ª—è –ø—Ä–æ–≥—Ä–µ—Å—Å –±–∞—Ä–∞
progressContainer.addEventListener('mousedown', (e) => {
    isDragging = true;
    isPlayingBeforeDrag = !audioPlayer.paused;
    updateDragPosition(e);
});

document.addEventListener('mousemove', (e) => {
    if (isDragging) updateDragPosition(e);
});

document.addEventListener('mouseup', () => {
    if (isDragging) {
        isDragging = false;
        audioPlayer.currentTime = dragPercent * audioPlayer.duration;
        updateProgress();
        if (isPlayingBeforeDrag) audioPlayer.play();
        isPlayingBeforeDrag = false;
    }
});

progressContainer.addEventListener('mousemove', (e) => {
    const rect = progressContainer.getBoundingClientRect();
    const offsetX = Math.min(Math.max(e.clientX - rect.left, 0), rect.width);
    const percent = offsetX / rect.width;
    const previewTime = percent * audioPlayer.duration;
    updateTooltip(offsetX, previewTime);
    timeTooltip.style.opacity = 1;
});

progressContainer.addEventListener('mouseleave', () => {
    timeTooltip.style.opacity = 0;
});

// –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π –¥–ª—è –∞—É–¥–∏–æ –ø–ª–µ–µ—Ä–∞
playPauseBtn.addEventListener('click', playPause);

audioPlayer.addEventListener('timeupdate', () => {
    updateProgress();
});

audioPlayer.addEventListener('ended', () => {
    playPauseBtn.innerHTML = '<i class="fas fa-play"></i>';
    albumCover.classList.remove('playing');
    isPlaying = false;
    lyricsLine.classList.remove('slide-in');
    lyricsLine.classList.add('slide-out');
    
    setTimeout(() => {
            document.querySelector('.lyrics-container').classList.remove('visible');
        }, 500);
    });

audioPlayer.addEventListener('play', () => {
    // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º lyrics-container —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –ø–µ—Å–Ω—è –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ –∏–≥—Ä–∞–µ—Ç (–∞ –Ω–µ –≤–æ–∑–æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è –ø–æ—Å–ª–µ –ø–∞—É–∑—ã)
    if (isPlaying) {
        const container = document.querySelector('.lyrics-container');
        // –í —Ç–µ–º–Ω–æ–π —Ç–µ–º–µ —Å–Ω–∞—á–∞–ª–∞ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º display: flex, –∑–∞—Ç–µ–º –¥–æ–±–∞–≤–ª—è–µ–º –∫–ª–∞—Å—Å visible
                if (document.body.classList.contains(darkModeClass)) {
                    container.style.display = 'flex';
                    // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –Ω–∞—á–∞–ª—å–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è –¥–ª—è –ø–ª–∞–≤–Ω–æ–≥–æ –ø–æ—è–≤–ª–µ–Ω–∏—è
                    container.style.opacity = '0';
                    container.style.transform = 'translateY(15px)';
                    
                    // –ù–µ–±–æ–ª—å—à–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞ –¥–ª—è —Å—Ä–∞–±–∞—Ç—ã–≤–∞–Ω–∏—è transition, –∑–∞—Ç–µ–º –¥–æ–±–∞–≤–ª—è–µ–º –∫–ª–∞—Å—Å visible
                    requestAnimationFrame(() => {
                        container.classList.add('visible');
                        // –°–±—Ä–∞—Å—ã–≤–∞–µ–º inline —Å—Ç–∏–ª–∏, —á—Ç–æ–±—ã –∫–ª–∞—Å—Å visible –º–æ–≥ —É–ø—Ä–∞–≤–ª—è—Ç—å opacity –∏ transform
                        container.style.opacity = '';
                        container.style.transform = '';
                    });
                } else {
                    container.classList.add('visible');
                }
        
        // Force reflow to trigger transition
        void container.offsetHeight;
        
        setTimeout(() => {
            lyricsLine.classList.remove('slide-out');
            lyricsLine.classList.add('slide-in');
            
            // –£–¥–∞–ª—è–µ–º –∫–ª–∞—Å—Å slide-in –ø–æ—Å–ª–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –∞–Ω–∏–º–∞—Ü–∏–∏
            setTimeout(() => {
                lyricsLine.classList.remove('slide-in');
            }, 500);
        }, 100);
    }
});

audioPlayer.addEventListener('pause', () => {
    lyricsLine.classList.remove('slide-in');
    lyricsLine.classList.add('slide-out');
    
    setTimeout(() => {
        document.querySelector('.lyrics-container').classList.remove('visible');
        document.querySelector('.links').style.paddingTop = '75px';
    }, 500);
});

// –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –≥—Ä–æ–º–∫–æ—Å—Ç—å—é
volumeSlider.addEventListener('input', () => {
    audioPlayer.volume = volumeSlider.value;
    if (audioPlayer.volume > 0) {
        isMuted = false;
        audioPlayer.muted = false;
        volumeToggle.innerHTML = '<i class="fas fa-volume-up"></i>';
        volumeWrapper.classList.remove('active');
    } else {
        isMuted = true;
        audioPlayer.muted = true;
        volumeToggle.innerHTML = '<i class="fas fa-volume-mute"></i>';
        volumeWrapper.classList.add('active');
    }
});

volumeToggle.addEventListener('click', () => {
    volumeWrapper.classList.toggle('active');
    isMuted = !isMuted;
    audioPlayer.muted = isMuted;
    volumeToggle.innerHTML = isMuted
        ? '<i class="fas fa-volume-mute"></i>'
        : '<i class="fas fa-volume-up"></i>';
});

// –ü–æ–∫–∞–∑—ã–≤–∞—Ç—å –ø–æ–ª–∑—É–Ω–æ–∫ –ø—Ä–∏ –Ω–∞–≤–µ–¥–µ–Ω–∏–∏ –Ω–∞ –∏–∫–æ–Ω–∫—É
volumeToggle.addEventListener('mouseenter', showVolumeBar);
volumeBar.addEventListener('mouseenter', showVolumeBar);

// –°–∫—Ä—ã–≤–∞—Ç—å –ø–æ–ª–∑—É–Ω–æ–∫ –ø—Ä–∏ —É—Ö–æ–¥–µ –∫—É—Ä—Å–æ—Ä–∞
volumeWrapper.addEventListener('mouseleave', (e) => {
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –∫—É—Ä—Å–æ—Ä –Ω–µ –Ω–∞–¥ –ø–æ–ª–∑—É–Ω–∫–æ–º –∏ –Ω–µ –Ω–∞–¥ –∏–∫–æ–Ω–∫–æ–π
    if (!volumeBar.matches(':hover') && !volumeToggle.matches(':hover')) {
        hideVolumeBar();
    }
});

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
document.addEventListener('DOMContentLoaded', async () => {
    // –ò–∑–Ω–∞—á–∞–ª—å–Ω–æ —Å–∫—Ä—ã–≤–∞–µ–º —Ç–µ–∫—Å—Ç –ø–µ—Å–Ω–∏
    const lyricsContainer = document.querySelector('.lyrics-container');
    lyricsContainer.classList.remove('visible');
    
    const savedTheme = localStorage.getItem(themeKey);
    if (savedTheme === 'dark') {
        document.body.classList.add(darkModeClass);
        themeSwitcher.textContent = moonIcon;
    } else {
        themeSwitcher.textContent = sunIcon;
    }
    
    // –í —Ç–µ–º–Ω–æ–π —Ç–µ–º–µ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º display: none
    if (document.body.classList.contains(darkModeClass)) {
        lyricsContainer.style.display = 'none';
    }
    
    // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ animationend –¥–ª—è —É—Å—Ç–∞–Ω–æ–≤–∫–∏ display: none –ø–æ—Å–ª–µ –∏—Å—á–µ–∑–Ω–æ–≤–µ–Ω–∏—è
        lyricsContainer.addEventListener('animationend', (e) => {
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –∞–Ω–∏–º–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞ –¥–ª—è lyricsContainerDisappear
            if (e.animationName === 'lyricsContainerDisappear' && !lyricsContainer.classList.contains('visible')) {
                // –í —Ç–µ–º–Ω–æ–π —Ç–µ–º–µ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º display: none –ø–æ—Å–ª–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –∞–Ω–∏–º–∞—Ü–∏–∏
                if (document.body.classList.contains(darkModeClass)) {
                    lyricsContainer.style.display = 'none';
                }
            }
        });

    try {
        const response = await fetch('music.mp3');
        if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
        const blob = await response.blob();
        const metadata = await musicMetadata.parseBlob(blob);

        document.getElementById('song-title').textContent = metadata.common.title || "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π —Ç—Ä–µ–∫";
        document.getElementById('song-artist').textContent = metadata.common.artist || "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—å";

        if (metadata.common.picture?.length) {
            const picture = metadata.common.picture[0];
            const base64String = arrayBufferToBase64(picture.data);
            document.getElementById('album-art').src = `data:${picture.format};base64,${base64String}`;
        }

        if (metadata.format.duration) {
            document.getElementById('duration').textContent = formatTime(metadata.format.duration);
        }

        // –°–±—Ä–æ—Å –ø—Ä–æ–≥—Ä–µ—Å—Å –±–∞—Ä–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
        progressBar.style.width = '0%';
        currentTimeEl.textContent = '0:00';
    } catch (err) {
        console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ —á—Ç–µ–Ω–∏–∏ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã—Ö:", err);
        document.getElementById('song-title').textContent = "–û—à–∏–±–∫–∞ —á—Ç–µ–Ω–∏—è —Ç–µ–≥–æ–≤";
        document.getElementById('song-artist').textContent = "";
    }
    
    if (loadingAnimation) {
        loadingAnimation.style.animation = 'noteToLyrics 1s ease-in-out forwards';
    }
    
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏—è .links –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã (–∞—É–¥–∏–æ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –Ω–∞ –ø–∞—É–∑–µ)
    const linksBlock = document.querySelector('.links');
    linksBlock.style.paddingTop = '75px';
});
